<html layout:decorate="~{layout}">
<div layout:fragment="content" class="container my-3">
    <h4 class="highlight" style="text-align:center;" th:text="|${post.id}번째 톡|"></h4>
    <div class="my-3">
        <div style="border-top:2px solid #d8d3e0; border-bottom:2px solid #d8d3e0; padding:20px;">
            <h5 th:text="${post.content}" class="my-2"></h5>
            <div class="d-flex align-items-end">
                <img th:src="@{${post.writer.image}}" alt="" style="width:30px; height:30px; border-radius:10px;"
                     class="me-2">
                <div th:text="${post.writer.nickName}" style="font-weight:bold;"></div>
                <div style="font-size:10pt; font-family:'nanum-light'; color:gray;" class="ms-2"
                     th:text="${#temporals.format(post.createDate, 'yyyy-MM-dd HH:mm')}"></div>
            </div>
            <div class="d-flex justify-content-end">
                <a href="javascript:void(0)" class="btn btn-sm 버튼" id="copyBtn"><i class="bi bi-clipboard me-1"></i>url
                    복사</a>
                <a th:href="@{|/post/modify/${post.id}|}" class="btn btn-sm 버튼 mx-2"
                   th:if="${post.writer.username == user.username}"><i
                        class="bi bi-pencil-square me-1"></i>수정</a>
                <a href="javascript:void(0)" th:data-uri="@{|/post/delete/${post.id}|}" id="deleteP"
                   class="btn btn-sm 버튼" th:if="${post.writer.username == user.username}"><i
                        class="bi bi-trash3 me-1"></i>삭제</a>
            </div>
        </div>
        <h5 class="my-3" th:text="|댓글 [${#lists.size(post.commentList)}]|"></h5>
        <div>
            <form th:action="@{|/comment/create/${post.id}|}" method="post" class="input-group" id="regForm">
                <input type="text" id="content" name="content" class="form-control">
                <input type="button" value="등록" class="btn 버튼-full" id="regBtn">
            </form>
        </div>
        <div th:each="comment : ${post.commentList}" class="my-3 py-2" style="border-bottom:1px solid lightgray;">
            <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                    <img th:src="@{${comment.writer.image}}" alt="" style="width:25px;height:25px;border-radius:10px;"
                         class="me-2">
                    <div th:text="${comment.writer.nickName}" style="font-weight:bold;"></div>
                    <span class="mx-3">:</span>
                    <div th:text="${comment.content}"></div>
                </div>
                <div style="font-size:10pt; font-family:'nanum-light'; color:gray;"
                     th:text="${#temporals.format(comment.createDate, 'yyyy-MM-dd HH:mm')}"></div>
            </div>
            <div th:if="${comment.writer.username == user.username}" class="text-end" style="font-size:10pt;">
                <a href="javascript:void(0)" class="commentModifyBtn" th:data-id="${comment.id}"
                   th:data-text="${comment.content}">수정</a>
                <span class="mx-1">|</span>
                <a href="javascript:void(0)" class="deleteC"
                   th:data-uri="@{|/comment/delete/${comment.id}|}">삭제</a>
            </div>
        </div>
        <!-- 댓글 수정 모달 -->
        <div class="modal fade" id="commentModifyModal" tabindex="-1" aria-labelledby="commentModifyModalLabel"
             aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5" id="commentModifyModalLabel">댓글 수정</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="modifiedCommentId">
                        <textarea name="content" id="modifyContent" cols="30" rows="7" class="form-control"></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn 버튼-full" id="commentModifyFinishBtn">수정</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script layout:fragment="script">
    $(function () {

        $('#copyBtn').click(function () {
            var urlToCopy = window.location.href;
            navigator.clipboard.writeText(urlToCopy).then(function () {
                alert('URL이 클립보드에 복사되었습니다.');
            }).catch(function (error) {
                alert('복사에 실패했습니다: ', error);
            });
        });

        $("#regBtn").on('click', function () {
            if ($("#content").val() == "")
                alert("댓글 내용을 입력해주세요.");
            else {
                alert("댓글이 등록되었습니다.");
                $("#regForm").submit();
            }
        });

        $("#deleteP").on('click', function () {
            if (confirm("이 톡을 삭제하시겠습니까?"))
                location.href = this.dataset.uri;
        });

        $("#commentModifyFinishBtn").on('click', function () {
            const commentContent = $("#modifyContent").val().trim();
            const commentId = $("#modifiedCommentId").val();
            if (commentContent === "")
                alert("수정할 내용을 입력해주세요.");
            else {
                $.ajax({
                    url: "/comment/modify",
                    type: "post",
                    headers: {
                        [csrfHeader]: csrfToken
                    },
                    contentType: "application/json",
                    data: JSON.stringify({
                        id: commentId,
                        content: commentContent
                    }),
                    success: () => {
                        alert("댓글이 수정되었습니다.");
                        window.location.reload();
                    },
                    error: (err) => {
                        alert("댓글 수정이 실패했습니다.");
                        console.log(err);
                    }
                });
            }
        });

        $(".deleteC").on('click', function () {
            if (confirm("댓글을 삭제하시겠습니까?")) {
                location.href = this.dataset.uri;
            }
        });

        $(".commentModifyBtn").click(function () {
            $("#modifiedCommentId").val($(this).data("id"));
            $("#modifyContent").val($(this).data("text"));
            $("#commentModifyModal").modal("show");
        });

    });
</script>
</html>