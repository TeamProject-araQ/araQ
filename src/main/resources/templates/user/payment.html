<html layout:decorate="~{layout}">
<div layout:fragment="content" class="container my-3">
    <h5>결제 수단을 선택해주세요.</h5>
    <div>
        <button onclick="selectPg('kakaopay')" class="btn" data-bs-toggle="button">카카오페이</button>
        <button onclick="selectPg('uplus')" class="btn" data-bs-toggle="button">토스페이먼츠</button>
        <button onclick="selectPg('danal')" class="btn" data-bs-toggle="button">휴대폰 결제</button>
    </div>
    <h5>결제할 버블을 선택해주세요.</h5>
    <div>
        <input onclick="pay(this.value)" type="button" value="100">
        <input onclick="pay(this.value)" type="button" value="300">
        <input onclick="pay(this.value)" type="button" value="500">
        <input onclick="pay(this.value)" type="button" value="1000">
    </div>
</div>
<input type="hidden" th:value="${user}">
<script type="text/javascript" layout:fragment="script">

    IMP.init('imp65467420');

    var selectedPg = '';

    function selectPg(pg) {
        selectedPg = pg;
    }

    var csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
    var csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

    function pay(amount) {
        if (!selectedPg) {
            alert('결제 수단을 선택해주세요.');
            return;
        }

        IMP.request_pay({
            pg: selectedPg,
            pay_method: 'card',
            merchant_uid: '[[${user.id}]]' + new Date().getTime(),
            name: 'AraQ_Bubble 결제',
            amount: amount,
            buyer_email: '[[${user.email}]]',
            buyer_name: '[[${user.username}]]',
            buyer_tel: '[[${user.phoneNum}]]',
            buyer_addr: '[[${user.address}]]',
            status: status
        }, function (rsp) {
            if (rsp.success) {
                var data = {
                    orderNum: rsp.merchant_uid,
                    amount: rsp.paid_amount,
                    method: rsp.pay_method,
                    username: rsp.buyer_name,
                    card: rsp.card_name,
                    impUid: rsp.imp_uid,
                    status: rsp.status,
                    pg: rsp.pg_provider
                };
                $.ajax({
                    url: '/charge',
                    type: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        [csrfHeader]: csrfToken
                    },
                    data: JSON.stringify(data),
                    success: function(response) {
                        alert(response);
                        location.reload();
                    },
                    error: function(xhr, status, error) {
                        console.error('Error:', error);
                    }
                });
            }
        });
    }
</script>
</html>
